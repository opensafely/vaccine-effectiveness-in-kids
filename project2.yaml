version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Pre-server scripts 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and tidy 
  ## # # # # # # # # # # # # # # # # # # # 

  generate_study_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated  --output-format
      feather
    outputs:
      highly_sensitive:
        cohort: output/input_treated.feather

  generate_dataset_report_treated:
    run: dataset-report:v0.0.24 --input-files output/input_treated.feather  --output-dir
      output/
    needs:
    - generate_study_treated
    outputs:
      moderately_sensitive:
        dataset_report: output/input_treated.html

  data_process_treated_over12:
    run: 'r:latest analysis/data_process_treated.R over12 '
    needs:
    - generate_study_treated
    outputs:
      highly_sensitive:
        rds: output/data/data_treated_eligible_over12.rds
      moderately_sensitive:
        flowchart: output/data/flowchart_treated_eligible_over12.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## skim data 
  ## # # # # # # # # # # # # # # # # # # # 

  skim_data_treated_over12:
    run: r:latest analysis/data_skim.R output/data/data_treated_eligible_over12.rds  output/data_properties
    needs:
    - data_process_treated_over12
    outputs:
      moderately_sensitive:
        txt: output/data_properties/data_treated_eligible_over12*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## matching round 1 
  ## # # # # # # # # # # # # # # # # # # # 

  generate_study_control_potential1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_control_potential
      --output-format feather --index-date-range "2021-09-20 to 2021-09-20 by week"
    outputs:
      highly_sensitive:
        dataset_report: output/input_control_potential_2021-09-20.feather

  data_process_control_potential1_over12:
    run: r:latest analysis/data_process_control_potential.R over12 1
    needs:
    - generate_study_control_potential1
    outputs:
      highly_sensitive:
        rds: output/data/data_control_potential1_over12.rds

  matching1_over12:
    run: r:latest analysis/matching.R over12 1
    needs:
    - data_process_treated_over12
    - data_process_control_potential1_over12
    outputs:
      highly_sensitive:
        rds1: output/match/data_potential_matchstatus1_over12.rds
        rds2: output/match/data_potential_matched1_over12.rds
        csv: output/match/potential_matched_controls1_over12.csv.gz

  skim_potential_matched1_over12:
    run: r:latest analysis/data_skim.R output/match/data_potential_matched1_over12.rds  output/data_properties
    needs:
    - matching1_over12
    outputs:
      moderately_sensitive:
        txt: output/data_properties/data_potential_matched1_over12*.txt

  generate_study_control_match1:
    run: |-
      cohortextractor:latest generate_cohort
      --study-definition study_definition_control_match1
      --output-format feather
    needs:
    - matching1_over12
    outputs:
      highly_sensitive:
        cohort: output/input_control_match1.feather

  generate_dataset_report_control_match1:
    run: dataset-report:v0.0.24 --input-files output/input_control_match1.feather  --output-dir
      output/
    needs:
    - generate_study_control_match1
    outputs:
      moderately_sensitive:
        dataset_report: output/input_control_match1.html

  matching_filter1_over12:
    run: r:latest analysis/matching_filter.R over12 1
    needs:
    - matching1_over12
    - generate_study_control_potential1
    outputs:
      highly_sensitive:
        rds1: output/match/data_matchstatus_allrounds1_over12.rds
        rds2: output/match/data_match_actual1_over12.rds

